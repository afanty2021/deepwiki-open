# é«˜å¯ç”¨æ€§ä¸ç³»ç»Ÿç›‘æ§é…ç½®æŒ‡å—

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**
- [docker-compose.yml](file://docker-compose.yml)
- [Dockerfile](file://Dockerfile)
- [api/main.py](file://api/main.py)
- [api/logging_config.py](file://api/logging_config.py)
- [api/api.py](file://api/api.py)
- [api/config.py](file://api/config.py)
- [run.sh](file://run.sh)
- [README.md](file://README.md)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [é¡¹ç›®æ¶æ„æ¦‚è§ˆ](#é¡¹ç›®æ¶æ„æ¦‚è§ˆ)
3. [å®¹å™¨é«˜å¯ç”¨æ€§é…ç½®](#å®¹å™¨é«˜å¯ç”¨æ€§é…ç½®)
4. [ç³»ç»Ÿçº§ç›‘æ§é…ç½®](#ç³»ç»Ÿçº§ç›‘æ§é…ç½®)
5. [åº”ç”¨å±‚ç›‘æ§ä¸å¥åº·æ£€æŸ¥](#åº”ç”¨å±‚ç›‘æ§ä¸å¥åº·æ£€æŸ¥)
6. [æ—¥å¿—ç®¡ç†ä¸è½®è½¬ç­–ç•¥](#æ—¥å¿—ç®¡ç†ä¸è½®è½¬ç­–ç•¥)
7. [äº‘æœåŠ¡å•†ç›‘æ§é›†æˆ](#äº‘æœåŠ¡å•†ç›‘æ§é›†æˆ)
8. [å¼€æºç›‘æ§æ–¹æ¡ˆ](#å¼€æºç›‘æ§æ–¹æ¡ˆ)
9. [å‘Šè­¦è§„åˆ™ä¸é€šçŸ¥](#å‘Šè­¦è§„åˆ™ä¸é€šçŸ¥)
10. [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)
11. [æœ€ä½³å®è·µå»ºè®®](#æœ€ä½³å®è·µå»ºè®®)

## ç®€ä»‹

deepwiki-open æ˜¯ä¸€ä¸ªåŸºäº FastAPI å’Œ Next.js æ„å»ºçš„æ™ºèƒ½çŸ¥è¯†åº“ç³»ç»Ÿï¼Œæ”¯æŒå¤šç§å¤§è¯­è¨€æ¨¡å‹æä¾›å•†ã€‚ä¸ºäº†ç¡®ä¿è¯¥ç³»ç»Ÿåœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„é«˜å¯ç”¨æ€§å’Œç¨³å®šæ€§ï¼Œéœ€è¦å®æ–½å®Œå–„çš„ç›‘æ§å’Œé«˜å¯ç”¨æ€§é…ç½®ç­–ç•¥ã€‚

æœ¬æŒ‡å—å°†è¯¦ç»†ä»‹ç»å¦‚ä½•é…ç½® docker-compose.yml ä¸­çš„é‡å¯ç­–ç•¥ã€è®¾ç½® systemd æœåŠ¡ã€é›†æˆäº‘ç›‘æ§å·¥å…·ä»¥åŠå®ç°å®Œæ•´çš„ç›‘æ§ä½“ç³»ã€‚

## é¡¹ç›®æ¶æ„æ¦‚è§ˆ

deepwiki-open é‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š

```mermaid
graph TB
subgraph "å‰ç«¯å±‚"
NextJS[Next.js åº”ç”¨<br/>ç«¯å£: 3000]
end
subgraph "åç«¯å±‚"
FastAPI[FastAPI API<br/>ç«¯å£: 8001]
API[API æœåŠ¡]
end
subgraph "æ•°æ®å±‚"
Adalflow[Adalflow æ•°æ®å­˜å‚¨<br/>è·¯å¾„: ~/.adalflow]
Logs[æ—¥å¿—ç›®å½•<br/>è·¯å¾„: ./api/logs]
end
subgraph "å¤–éƒ¨ä¾èµ–"
Embedding[åµŒå…¥æ¨¡å‹æœåŠ¡]
LLM[å¤§è¯­è¨€æ¨¡å‹æœåŠ¡]
Cache[ç¼“å­˜å­˜å‚¨]
end
NextJS --> FastAPI
FastAPI --> API
API --> Adalflow
API --> Logs
API --> Embedding
API --> LLM
API --> Cache
```

**å›¾è¡¨æ¥æº**
- [docker-compose.yml](file://docker-compose.yml#L1-L30)
- [Dockerfile](file://Dockerfile#L1-L112)

**ç« èŠ‚æ¥æº**
- [docker-compose.yml](file://docker-compose.yml#L1-L30)
- [Dockerfile](file://Dockerfile#L1-L112)

## å®¹å™¨é«˜å¯ç”¨æ€§é…ç½®

### Docker Compose é‡å¯ç­–ç•¥é…ç½®

åœ¨ docker-compose.yml ä¸­æ·»åŠ  `restart: unless-stopped` ç­–ç•¥æ˜¯ç¡®ä¿å®¹å™¨å¼‚å¸¸é€€å‡ºåè‡ªåŠ¨é‡å¯çš„å…³é”®é…ç½®ã€‚

#### å½“å‰é…ç½®åˆ†æ

é¡¹ç›®ç°æœ‰çš„ docker-compose.yml å·²ç»åŒ…å«äº†åŸºæœ¬çš„å¥åº·æ£€æŸ¥é…ç½®ï¼š

```yaml
# å¥åº·æ£€æŸ¥é…ç½®
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:${PORT:-8001}/health"]
  interval: 60s
  timeout: 10s
  retries: 3
  start_period: 30s
```

#### æ¨èçš„å®Œæ•´é‡å¯ç­–ç•¥é…ç½®

```yaml
services:
  deepwiki:
    # ç°æœ‰é…ç½®...
    restart: unless-stopped  # æ·»åŠ é‡å¯ç­–ç•¥
    # å¥åº·æ£€æŸ¥é…ç½®...
```

#### é‡å¯ç­–ç•¥è¯¦è§£

| ç­–ç•¥ç±»å‹ | æè¿° | é€‚ç”¨åœºæ™¯ |
|---------|------|----------|
| `no` | ä¸è‡ªåŠ¨é‡å¯ | å¼€å‘è°ƒè¯•ç¯å¢ƒ |
| `always` | æ€»æ˜¯é‡å¯ï¼Œæ— è®ºé€€å‡ºç  | æµ‹è¯•ç¯å¢ƒ |
| `on-failure` | ä»…åœ¨éé›¶é€€å‡ºç æ—¶é‡å¯ | ç”Ÿäº§ç¯å¢ƒï¼Œå…è®¸æ‰‹åŠ¨å¹²é¢„ |
| `unless-stopped` | é™¤éæ‰‹åŠ¨åœæ­¢ï¼Œå¦åˆ™é‡å¯ | ç”Ÿäº§ç¯å¢ƒæ¨è |

### Docker å®ˆæŠ¤è¿›ç¨‹å¼€æœºè‡ªå¯

#### Ubuntu/Debian ç³»ç»Ÿé…ç½®

```bash
# å¯ç”¨ Docker æœåŠ¡å¼€æœºè‡ªå¯
sudo systemctl enable docker

# æ£€æŸ¥ Docker æœåŠ¡çŠ¶æ€
sudo systemctl status docker

# å¦‚æœéœ€è¦ï¼Œå¯ä»¥è®¾ç½® docker-compose æœåŠ¡è‡ªå¯
sudo systemctl enable docker-compose
```

#### CentOS/RHEL ç³»ç»Ÿé…ç½®

```bash
# å¯ç”¨ Docker æœåŠ¡
sudo systemctl enable docker.service

# å¯åŠ¨ Docker æœåŠ¡
sudo systemctl start docker
```

**ç« èŠ‚æ¥æº**
- [docker-compose.yml](file://docker-compose.yml#L24-L29)

## ç³»ç»Ÿçº§ç›‘æ§é…ç½®

### ç³»ç»Ÿèµ„æºç›‘æ§

#### CPU å’Œå†…å­˜ç›‘æ§

```bash
# ç›‘æ§å®¹å™¨èµ„æºä½¿ç”¨æƒ…å†µ
docker stats deepwiki

# æŸ¥çœ‹ç³»ç»Ÿæ•´ä½“èµ„æºä½¿ç”¨
htop
free -h
```

#### å­˜å‚¨ç©ºé—´ç›‘æ§

```bash
# ç›‘æ§ç£ç›˜ä½¿ç”¨æƒ…å†µ
df -h

# ç›‘æ§ç‰¹å®šç›®å½•å¤§å°
du -sh ~/.adalflow
du -sh ./api/logs
```

### ç½‘ç»œè¿æ¥ç›‘æ§

```bash
# ç›‘æ§ç«¯å£å ç”¨æƒ…å†µ
netstat -tlnp | grep :8001
netstat -tlnp | grep :3000

# æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
sudo ufw status
sudo iptables -L
```

## åº”ç”¨å±‚ç›‘æ§ä¸å¥åº·æ£€æŸ¥

### å¥åº·æ£€æŸ¥ç«¯ç‚¹å®ç°

deepwiki-open æä¾›äº†ä¸“é—¨çš„å¥åº·æ£€æŸ¥ç«¯ç‚¹ `/health`ï¼Œè¿™æ˜¯ç›‘æ§ç³»ç»Ÿçš„é‡è¦å…¥å£ã€‚

#### å¥åº·æ£€æŸ¥ç«¯ç‚¹åˆ†æ

```python
@app.get("/health")
async def health_check():
    """ç”¨äº Docker å’Œç›‘æ§"""
    return {
        "status": "healthy",
        "timestamp": datetime.now().isoformat(),
        "service": "deepwiki-api"
    }
```

#### å¥åº·æ£€æŸ¥å·¥ä½œåŸç†

```mermaid
sequenceDiagram
participant Monitor as ç›‘æ§ç³»ç»Ÿ
participant Container as Docker å®¹å™¨
participant API as DeepWiki API
Monitor->>Container : æ‰§è¡Œå¥åº·æ£€æŸ¥æµ‹è¯•
Container->>API : GET http : //localhost : 8001/health
API-->>Container : è¿”å›å¥åº·çŠ¶æ€
Container-->>Monitor : æŠ¥å‘Šå®¹å™¨çŠ¶æ€
Note over Monitor,API : å¥åº·æ£€æŸ¥é—´éš” : 60ç§’
Note over Monitor,API : è¶…æ—¶æ—¶é—´ : 10ç§’
Note over Monitor,API : é‡è¯•æ¬¡æ•° : 3æ¬¡
Note over Monitor,API : å¯åŠ¨æœŸ : 30ç§’
```

**å›¾è¡¨æ¥æº**
- [api/api.py](file://api/api.py#L540-L547)
- [docker-compose.yml](file://docker-compose.yml#L24-L29)

### è‡ªå®šä¹‰å¥åº·æ£€æŸ¥æ‰©å±•

#### å®ç°æ›´è¯¦ç»†çš„å¥åº·æ£€æŸ¥

```python
@app.get("/health/detailed")
async def detailed_health_check():
    """æä¾›æ›´è¯¦ç»†çš„å¥åº·æ£€æŸ¥ä¿¡æ¯"""
    health_data = {
        "status": "healthy",
        "timestamp": datetime.now().isoformat(),
        "service": "deepwiki-api",
        "checks": {
            "database": await check_database_connection(),
            "embedding_service": await check_embedding_service(),
            "llm_services": await check_llm_services(),
            "storage": await check_storage_space()
        }
    }
    
    # æ ¹æ®æ£€æŸ¥ç»“æœè°ƒæ•´çŠ¶æ€
    if not all(health_data["checks"].values()):
        health_data["status"] = "unhealthy"
    
    return health_data
```

**ç« èŠ‚æ¥æº**
- [api/api.py](file://api/api.py#L540-L547)

## æ—¥å¿—ç®¡ç†ä¸è½®è½¬ç­–ç•¥

### æ—¥å¿—é…ç½®åˆ†æ

deepwiki-open æä¾›äº†å®Œå–„çš„æ—¥å¿—ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒåŠ¨æ€é…ç½®å’Œè½®è½¬ã€‚

#### æ—¥å¿—é…ç½®å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | æè¿° |
|------|--------|------|
| `LOG_LEVEL` | INFO | æ—¥å¿—çº§åˆ« |
| `LOG_FILE_PATH` | api/logs/application.log | æ—¥å¿—æ–‡ä»¶è·¯å¾„ |
| `LOG_MAX_SIZE` | 10MB | å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å¤§å° |
| `LOG_BACKUP_COUNT` | 5 | å¤‡ä»½æ–‡ä»¶æ•°é‡ |

#### æ—¥å¿—è½®è½¬é…ç½®

```python
# æ—¥å¿—è½®è½¬å®ç°
file_handler = RotatingFileHandler(
    resolved_path, 
    maxBytes=max_bytes, 
    backupCount=backup_count, 
    encoding="utf-8"
)
```

### æ¨èçš„æ—¥å¿—è½®è½¬ç­–ç•¥

#### 1. æ–‡ä»¶å¤§å°é™åˆ¶

```bash
# åˆ›å»ºæ—¥å¿—è½®è½¬é…ç½®æ–‡ä»¶
cat > /etc/logrotate.d/deepwiki << EOF
/app/api/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        docker exec deepwiki-app kill -USR1 \$(cat /var/run/nginx.pid)
    endscript
}
EOF
```

#### 2. æ—¥å¿—ä¿ç•™ç­–ç•¥

```bash
# æ¸…ç†è¶…è¿‡30å¤©çš„æ—¥å¿—æ–‡ä»¶
find /app/api/logs -name "*.log.*" -mtime +30 -delete
```

#### 3. æ—¥å¿—ç›‘æ§è„šæœ¬

```bash
#!/bin/bash
# æ—¥å¿—ç›‘æ§è„šæœ¬

LOG_DIR="/app/api/logs"
THRESHOLD_SIZE=104857600  # 100MB

# æ£€æŸ¥æ—¥å¿—æ–‡ä»¶å¤§å°
for logfile in $LOG_DIR/*.log; do
    if [ -f "$logfile" ]; then
        size=$(stat -f%z "$logfile")
        if [ $size -gt $THRESHOLD_SIZE ]; then
            echo "è­¦å‘Š: æ—¥å¿—æ–‡ä»¶ $logfile è¶…è¿‡å¤§å°é™åˆ¶ ($size > $THRESHOLD_SIZE)"
            # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é‚®ä»¶é€šçŸ¥
        fi
    fi
done
```

**ç« èŠ‚æ¥æº**
- [api/logging_config.py](file://api/logging_config.py#L1-L86)

## äº‘æœåŠ¡å•†ç›‘æ§é›†æˆ

### AWS CloudWatch é›†æˆ

#### 1. CloudWatch Agent é…ç½®

```bash
# å®‰è£… CloudWatch Agent
sudo yum install amazon-cloudwatch-agent -y

# åˆ›å»ºé…ç½®æ–‡ä»¶
cat > /opt/aws/amazon-cloudwatch-agent/bin/config.json << EOF
{
    "agent": {
        "metrics_collection_interval": 60,
        "run_as_user": "cwagent"
    },
    "metrics": {
        "namespace": "DeepWiki/Monitoring",
        "metrics_collected": {
            "cpu": {
                "measurement": [
                    "cpu_usage_idle",
                    "cpu_usage_iowait",
                    "cpu_usage_user",
                    "cpu_usage_system"
                ],
                "metrics_collection_interval": 60
            },
            "disk": {
                "measurement": [
                    "used_percent",
                    "inodes_free"
                ],
                "metrics_collection_interval": 60,
                "resources": [
                    "/"
                ]
            },
            "mem": {
                "measurement": [
                    "mem_used_percent"
                ],
                "metrics_collection_interval": 60
            }
        }
    }
}
EOF

# å¯åŠ¨ CloudWatch Agent
sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/bin/config.json -s
```

#### 2. è‡ªå®šä¹‰æŒ‡æ ‡é…ç½®

```bash
# åˆ›å»ºè‡ªå®šä¹‰ç›‘æ§è„šæœ¬
cat > /usr/local/bin/deepwiki-monitoring.sh << 'EOF'
#!/bin/bash

# è·å–å®¹å™¨æŒ‡æ ‡
CONTAINER_NAME="deepwiki-app"
CPU_USAGE=$(docker stats --no-stream --format "table {{.CPUPerc}}" $CONTAINER_NAME | tail -1 | sed 's/%//')
MEMORY_USAGE=$(docker stats --no-stream --format "table {{.MemUsage}}" $CONTAINER_NAME | tail -1 | awk '{print $1}' | sed 's/MiB//')

# å‘é€åˆ° CloudWatch
aws cloudwatch put-metric-data \
    --metric-name CPUUsage \
    --namespace DeepWiki \
    --value $CPU_USAGE \
    --unit Percent \
    --region us-west-2

aws cloudwatch put-metric-data \
    --metric-name MemoryUsage \
    --namespace DeepWiki \
    --value $MEMORY_USAGE \
    --unit Megabytes \
    --region us-west-2
EOF

chmod +x /usr/local/bin/deepwiki-monitoring.sh
```

### Google Cloud Operations é›†æˆ

#### 1. Stackdriver Agent é…ç½®

```bash
# å®‰è£… Stackdriver Agent
curl -sSO https://dl.google.com/cloudagents/add-google-cloud-ops-agent-repo.sh
sudo bash add-google-cloud-ops-agent-repo.sh --also-install

# é…ç½®ç›‘æ§
cat > /etc/google-cloud-ops-agent/config.yaml << EOF
metrics:
  receivers:
    prometheus:
      type: prometheus
      listen_address: "0.0.0.0:9100"
  processors:
    resource_detection:
      detectors: [gce]
  exporters:
    google_cloud_monitoring:
      project: your-project-id
  service:
    pipelines:
      default_pipeline:
        receivers: [prometheus]
        processors: [resource_detection]
        exporters: [google_cloud_monitoring]
EOF

sudo systemctl restart google-cloud-ops-agent
```

#### 2. è‡ªå®šä¹‰æŒ‡æ ‡æ”¶é›†

```bash
# åˆ›å»ºç›‘æ§è„šæœ¬
cat > /usr/local/bin/gcp-monitoring.sh << 'EOF'
#!/bin/bash

# è·å– API å“åº”æ—¶é—´
RESPONSE_TIME=$(curl -w "%{time_total}" -o /dev/null -s http://localhost:8001/health)

# å‘é€åˆ° Cloud Monitoring
gcloud monitoring write timeseries \
    --descriptor-type="custom.googleapis.com/deepwiki/response_time" \
    --metric-labels="instance_id=\$(curl -s http://metadata.google.internal/computeMetadata/v1/instance/id -H "Metadata-Flavor: Google")" \
    --timeseries-data="{
        \"metric\": {
            \"type\": \"custom.googleapis.com/deepwiki/response_time\",
            \"labels\": {
                \"instance_id\": \"\$(curl -s http://metadata.google.internal/computeMetadata/v1/instance/id -H "Metadata-Flavor: Google\")\"
            }
        },
        \"resource\": {
            \"type\": \"gce_instance\",
            \"labels\": {
                \"instance_id\": \"\$(curl -s http://metadata.google.internal/computeMetadata/v1/instance/id -H "Metadata-Flavor: Google")\",
                \"zone\": \"\$(curl -s http://metadata.google.internal/computeMetadata/v1/instance/zone -H "Metadata-Flavor: Google")\"
            }
        },
        \"points\": [{
            \"interval\": {
                \"endTime\": \"\$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
            },
            \"value\": {
                \"doubleValue\": $RESPONSE_TIME
            }
        }]
    }"
EOF
```

## å¼€æºç›‘æ§æ–¹æ¡ˆ

### Prometheus + Grafana é›†æˆ

#### 1. Prometheus é…ç½®

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'deepwiki'
    static_configs:
      - targets: ['localhost:9100']
    metrics_path: '/metrics'
    
  - job_name: 'docker'
    static_configs:
      - targets: ['localhost:9323']
      
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['localhost:9100']
```

#### 2. Node Exporter é…ç½®

```bash
# å®‰è£… Node Exporter
wget https://github.com/prometheus/node_exporter/releases/download/v1.6.0/node_exporter-1.6.0.linux-amd64.tar.gz
tar xvfz node_exporter-1.6.0.linux-amd64.tar.gz
sudo mv node_exporter-1.6.0.linux-amd64/node_exporter /usr/local/bin/

# åˆ›å»º systemd æœåŠ¡
cat > /etc/systemd/system/node-exporter.service << EOF
[Unit]
Description=Node Exporter
After=network.target

[Service]
User=node_exporter
Group=node_exporter
Type=simple
ExecStart=/usr/local/bin/node_exporter

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable node-exporter
sudo systemctl start node-exporter
```

#### 3. Grafana ä»ªè¡¨æ¿é…ç½®

```json
{
  "dashboard": {
    "title": "DeepWiki Monitoring",
    "panels": [
      {
        "title": "API Response Time",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(deepwiki_request_duration_seconds_bucket[5m]))",
            "legendFormat": "{{job}}"
          }
        ]
      },
      {
        "title": "Container CPU Usage",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(container_cpu_usage_seconds_total{container_label_name=\"deepwiki\"}[5m]) * 100",
            "legendFormat": "{{container}}"
          }
        ]
      }
    ]
  }
}
```

### è‡ªå®šä¹‰æŒ‡æ ‡æ”¶é›†

#### 1. åº”ç”¨çº§æŒ‡æ ‡æ”¶é›†

```python
# metrics.py
from prometheus_client import Counter, Histogram, Gauge, start_http_server

# è¯·æ±‚è®¡æ•°å™¨
REQUEST_COUNT = Counter('deepwiki_requests_total', 'Total requests', ['method', 'endpoint', 'status'])
REQUEST_DURATION = Histogram('deepwiki_request_duration_seconds', 'Request duration', ['method', 'endpoint'])
ACTIVE_REQUESTS = Gauge('deepwiki_active_requests', 'Active requests')

# å¯åŠ¨ Prometheus æœåŠ¡å™¨
def start_metrics_server(port=9100):
    start_http_server(port)

# åœ¨ API ä¸­ä½¿ç”¨
@app.middleware("http")
async def metrics_middleware(request, call_next):
    REQUEST_COUNT.labels(method=request.method, endpoint=request.url.path).inc()
    ACTIVE_REQUESTS.inc()
    
    start_time = time.time()
    try:
        response = await call_next(request)
    finally:
        duration = time.time() - start_time
        REQUEST_DURATION.labels(
            method=request.method, 
            endpoint=request.url.path
        ).observe(duration)
        ACTIVE_REQUESTS.dec()
    
    return response
```

## å‘Šè­¦è§„åˆ™ä¸é€šçŸ¥

### å…³é”®ç›‘æ§æŒ‡æ ‡

#### 1. æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡åç§° | å‘Šè­¦é˜ˆå€¼ | å‘Šè­¦çº§åˆ« | é€šçŸ¥æ–¹å¼ |
|---------|----------|----------|----------|
| API å“åº”æ—¶é—´ | > 2ç§’ | è­¦å‘Š | é‚®ä»¶ + Slack |
| CPU ä½¿ç”¨ç‡ | > 80% | è­¦å‘Š | é‚®ä»¶ + SMS |
| å†…å­˜ä½¿ç”¨ç‡ | > 85% | ä¸¥é‡ | é‚®ä»¶ + ç”µè¯ |
| ç£ç›˜ä½¿ç”¨ç‡ | > 90% | ä¸¥é‡ | é‚®ä»¶ + Slack |
| å¥åº·æ£€æŸ¥å¤±è´¥ | è¿ç»­3æ¬¡å¤±è´¥ | ä¸¥é‡ | é‚®ä»¶ + ç”µè¯ |

#### 2. ä¸šåŠ¡æŒ‡æ ‡

| æŒ‡æ ‡åç§° | å‘Šè­¦é˜ˆå€¼ | å‘Šè­¦çº§åˆ« | é€šçŸ¥æ–¹å¼ |
|---------|----------|----------|----------|
| åµŒå…¥ç”Ÿæˆå¤±è´¥ç‡ | > 5% | è­¦å‘Š | é‚®ä»¶ + Slack |
| API é”™è¯¯ç‡ | > 1% | è­¦å‘Š | é‚®ä»¶ + SMS |
| ç¼“å­˜å‘½ä¸­ç‡ | < 90% | è­¦å‘Š | é‚®ä»¶ + Slack |
| æ•°æ®åº“è¿æ¥å¤±è´¥ | è¿ç»­3æ¬¡ | ä¸¥é‡ | é‚®ä»¶ + ç”µè¯ |

### å‘Šè­¦è§„åˆ™é…ç½®

#### Prometheus Alertmanager é…ç½®

```yaml
# alertmanager.yml
global:
  smtp_from: 'alertmanager@example.com'
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_auth_username: 'alertmanager@example.com'
  smtp_auth_password: 'password'

route:
  group_by: ['alertname', 'severity']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 12h
  receiver: 'default'
  routes:
    - match:
        severity: 'critical'
      receiver: 'critical-alerts'
    - match:
        severity: 'warning'
      receiver: 'warning-alerts'

receivers:
  - name: 'default'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#deepwiki-alerts'
        
  - name: 'critical-alerts'
    email_configs:
      - to: 'admin@example.com'
        subject: 'ğŸš¨ DeepWiki Critical Alert: {{ .GroupLabels.alertname }}'
        
  - name: 'warning-alerts'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#deepwiki-warnings'
```

#### è‡ªå®šä¹‰å‘Šè­¦è§„åˆ™

```yaml
# deepwiki.rules.yml
groups:
- name: deepwiki
  rules:
  - alert: HighAPILatency
    expr: histogram_quantile(0.95, rate(deepwiki_request_duration_seconds_bucket[5m])) > 2
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "High API latency detected"
      description: "API response time is {{ $value }} seconds"
      
  - alert: HighCPUUsage
    expr: rate(container_cpu_usage_seconds_total{container_label_name="deepwiki"}[5m]) * 100 > 80
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High CPU usage"
      description: "CPU usage is {{ $value }}%"
      
  - alert: HealthCheckFailure
    expr: up{job="deepwiki"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "DeepWiki service is down"
      description: "Health check endpoint is not responding"
```

### å‘Šè­¦é€šçŸ¥æ¨¡æ¿

#### 1. Slack é€šçŸ¥æ¨¡æ¿

```json
{
  "attachments": [
    {
      "color": "{{ if eq .Status \"firing\" }}danger{{ else }}good{{ end }}",
      "title": "{{ .GroupLabels.alertname }}",
      "text": "{{ .Annotations.summary }}\n{{ .Annotations.description }}",
      "fields": [
        {
          "title": "Severity",
          "value": "{{ .GroupLabels.severity }}",
          "short": true
        },
        {
          "title": "Instance",
          "value": "{{ $labels.instance }}",
          "short": true
        }
      ],
      "footer": "DeepWiki Monitoring",
      "footer_icon": "https://example.com/favicon.png",
      "ts": {{ .StartsAt.Unix }}
    }
  ]
}
```

#### 2. é‚®ä»¶é€šçŸ¥æ¨¡æ¿

```html
<!DOCTYPE html>
<html>
<head>
    <title>DeepWiki Alert: {{ .GroupLabels.alertname }}</title>
</head>
<body>
    <h2>{{ .GroupLabels.alertname }}</h2>
    <p>Status: {{ .Status }}</p>
    <p>Severity: {{ .GroupLabels.severity }}</p>
    <p>Description: {{ .Annotations.description }}</p>
    <p>Start Time: {{ .Alerts.Firing | first | .StartsAt }}</p>
    <p><a href="http://monitoring.example.com">View Dashboard</a></p>
</body>
</html>
```

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é—®é¢˜è¯Šæ–­

#### 1. å®¹å™¨å¯åŠ¨å¤±è´¥

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps -a

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs deepwiki

# æ£€æŸ¥é…ç½®æ–‡ä»¶
docker exec deepwiki cat /app/.env

# æ£€æŸ¥èµ„æºé™åˆ¶
docker stats deepwiki
```

#### 2. å¥åº·æ£€æŸ¥å¤±è´¥

```bash
# æ‰‹åŠ¨æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹
curl -v http://localhost:8001/health

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep 8001

# æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
docker exec deepwiki ps aux | grep python
```

#### 3. æ€§èƒ½é—®é¢˜è¯Šæ–­

```bash
# ç›‘æ§ç³»ç»Ÿèµ„æº
docker stats deepwiki

# åˆ†æ API æ€§èƒ½
curl -w "@curl-format.txt" -o /dev/null -s http://localhost:8001/health

# curl-format.txt å†…å®¹:
#     time_namelookup:  %{time_namelookup}\n
#        time_connect:  %{time_connect}\n
#     time_appconnect:  %{time_appconnect}\n
#    time_pretransfer:  %{time_pretransfer}\n
#       time_redirect:  %{time_redirect}\n
#  time_starttransfer:  %{time_starttransfer}\n
#                     ----------\n
#          time_total:  %{time_total}\n
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### 1. èµ„æºé…ç½®ä¼˜åŒ–

```yaml
services:
  deepwiki:
    # èµ„æºé™åˆ¶é…ç½®
    mem_limit: 8g
    mem_reservation: 2g
    cpu_quota: 400000  # 4 cores
    cpu_period: 100000
```

#### 2. ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

```python
# ç¼“å­˜é…ç½®ç¤ºä¾‹
CACHE_CONFIG = {
    "redis": {
        "host": "localhost",
        "port": 6379,
        "db": 0,
        "ttl": 3600  # 1å°æ—¶
    },
    "memory": {
        "max_size": 1000,
        "ttl": 1800  # 30åˆ†é’Ÿ
    }
}
```

## æœ€ä½³å®è·µå»ºè®®

### 1. ç›‘æ§ä½“ç³»å»ºè®¾

#### åˆ†å±‚ç›‘æ§ç­–ç•¥

```mermaid
graph TD
A[åŸºç¡€è®¾æ–½ç›‘æ§] --> B[å®¹å™¨ç›‘æ§]
B --> C[åº”ç”¨ç›‘æ§]
C --> D[ä¸šåŠ¡ç›‘æ§]
A1[CPU/å†…å­˜/ç£ç›˜] --> A
A2[ç½‘ç»œ/I/O] --> A
B1[Docker Stats] --> B
B2[å®¹å™¨èµ„æº] --> B
C1[API å“åº”æ—¶é—´] --> C
C2[é”™è¯¯ç‡] --> C
C3[å¥åº·æ£€æŸ¥] --> C
D1[ç”¨æˆ·æ´»è·ƒåº¦] --> D
D2[åŠŸèƒ½ä½¿ç”¨ç‡] --> D
D3[ä¸šåŠ¡æŒ‡æ ‡] --> D
```

#### ç›‘æ§æ•°æ®ä¿ç•™ç­–ç•¥

| æ—¶é—´èŒƒå›´ | ä¿ç•™æœŸé™ | å­˜å‚¨æˆæœ¬ | ç”¨é€” |
|---------|----------|----------|------|
| 1å‘¨ | 7å¤© | ä½ | æ—¥å¸¸è¿ç»´ |
| 1ä¸ªæœˆ | 30å¤© | ä¸­ç­‰ | æ•…éšœæ’æŸ¥ |
| 1å¹´ | 365å¤© | é«˜ | æ€§èƒ½åˆ†æ |
| æ°¸ä¹… | æ°¸ä¹… | æœ€é«˜ | åˆè§„å®¡è®¡ |

### 2. è‡ªåŠ¨åŒ–è¿ç»´

#### 1. è‡ªåŠ¨æ‰©å®¹é…ç½®

```yaml
# Kubernetes HPA é…ç½®ç¤ºä¾‹
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: deepwiki-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: deepwiki
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

#### 2. è‡ªåŠ¨å¤‡ä»½ç­–ç•¥

```bash
#!/bin/bash
# è‡ªåŠ¨å¤‡ä»½è„šæœ¬

BACKUP_DIR="/backups/deepwiki"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
docker exec deepwiki-db pg_dump -U postgres deepwiki > $BACKUP_DIR/db_$DATE.sql

# å¤‡ä»½é…ç½®æ–‡ä»¶
tar czf $BACKUP_DIR/config_$DATE.tar.gz /app/config/

# å¤‡ä»½æ—¥å¿—
tar czf $BACKUP_DIR/logs_$DATE.tar.gz /app/logs/

# æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™30å¤©ï¼‰
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete
```

### 3. å®‰å…¨ç›‘æ§

#### 1. è®¿é—®æ—¥å¿—åˆ†æ

```bash
# è®¿é—®æ—¥å¿—ç›‘æ§è„šæœ¬
cat > /usr/local/bin/access-log-monitor.sh << 'EOF'
#!/bin/bash

LOG_FILE="/app/logs/access.log"
ALERT_THRESHOLD=100

# ç»Ÿè®¡å¼‚å¸¸è®¿é—®
abnormal_access=$(awk '$9 ~ /^[45][0-9][0-9]$/ {count++} END {print count}' $LOG_FILE)

if [ $abnormal_access -gt $ALERT_THRESHOLD ]; then
    echo "è­¦å‘Š: æ£€æµ‹åˆ° $abnormal_access ä¸ªå¼‚å¸¸HTTPå“åº”" | mail -s "DeepWiki è®¿é—®å¼‚å¸¸å‘Šè­¦" admin@example.com
fi
EOF
```

#### 2. å®‰å…¨äº‹ä»¶ç›‘æ§

```python
# å®‰å…¨äº‹ä»¶æ£€æµ‹
import re
from datetime import datetime

def detect_security_events(log_entry):
    """æ£€æµ‹å®‰å…¨ç›¸å…³äº‹ä»¶"""
    events = []
    
    # æ£€æµ‹æš´åŠ›ç ´è§£å°è¯•
    if re.search(r'Failed password', log_entry):
        events.append({
            'type': 'brute_force',
            'severity': 'high',
            'timestamp': datetime.now(),
            'details': 'æ£€æµ‹åˆ°æš´åŠ›ç ´è§£å°è¯•'
        })
    
    # æ£€æµ‹å¼‚å¸¸APIè°ƒç”¨
    if re.search(r'/admin|/config|/secret', log_entry):
        events.append({
            'type': 'suspicious_api',
            'severity': 'medium',
            'timestamp': datetime.now(),
            'details': 'æ£€æµ‹åˆ°å¯ç–‘APIè°ƒç”¨'
        })
    
    return events
```

### 4. æ–‡æ¡£ä¸åŸ¹è®­

#### 1. ç›‘æ§æ“ä½œæ‰‹å†Œ

- åˆ¶å®šæ ‡å‡†çš„ç›‘æ§æ£€æŸ¥æ¸…å•
- å»ºç«‹æ•…éšœå“åº”æµç¨‹
- å®šæœŸè¿›è¡Œåº”æ€¥æ¼”ç»ƒ

#### 2. å›¢é˜ŸåŸ¹è®­è®¡åˆ’

- ç›‘æ§ç³»ç»Ÿä½¿ç”¨åŸ¹è®­
- æ•…éšœè¯Šæ–­æŠ€èƒ½åŸ¹è®­
- å‘Šè­¦å“åº”æµç¨‹åŸ¹è®­

é€šè¿‡å®æ–½æœ¬æŒ‡å—ä¸­çš„é…ç½®å’Œæœ€ä½³å®è·µï¼Œå¯ä»¥æ˜¾è‘—æå‡ deepwiki-open åœ¨äº‘ç¯å¢ƒä¸­çš„é«˜å¯ç”¨æ€§å’Œç›‘æ§èƒ½åŠ›ï¼Œç¡®ä¿ç³»ç»Ÿçš„ç¨³å®šè¿è¡Œå’Œå¿«é€Ÿæ•…éšœæ¢å¤ã€‚