# 云部署流程

<cite>
**本文档中引用的文件**
- [docker-compose.yml](file://docker-compose.yml)
- [Dockerfile](file://Dockerfile)
- [README.md](file://README.md)
- [run.sh](file://run.sh)
- [package.json](file://package.json)
- [api/main.py](file://api/main.py)
- [api/config.py](file://api/config.py)
- [api/README.md](file://api/README.md)
</cite>

## 目录
1. [简介](#简介)
2. [系统要求](#系统要求)
3. [云服务器准备](#云服务器准备)
4. [环境配置](#环境配置)
5. [Docker 安装与配置](#docker-安装与配置)
6. [项目部署](#项目部署)
7. [服务启动](#服务启动)
8. [端口配置与安全组](#端口配置与安全组)
9. [常见问题排查](#常见问题排查)
10. [监控与维护](#监控与维护)

## 简介

DeepWiki 是一个自动为 GitHub、GitLab 或 BitBucket 仓库生成精美交互式维基的 AI 工具。本文档提供了在 AWS EC2、Google Cloud 或其他 VPS 云平台上部署 DeepWiki 的完整指南，包括从服务器准备到服务启动的每个步骤。

## 系统要求

### 最低硬件要求
- **CPU**: 至少 4 核心
- **内存**: 至少 8GB RAM
- **存储**: 至少 20GB 可用空间
- **网络**: 稳定的互联网连接

### 推荐硬件配置
- **CPU**: 8 核心或更多
- **内存**: 16GB 或更多（如果运行本地 LLM）
- **存储**: 50GB 或更多 SSD 存储
- **网络**: 千兆网卡

### 支持的操作系统
- Ubuntu 20.04 LTS 或更高版本
- Ubuntu 22.04 LTS 或更高版本

**节来源**
- [docker-compose.yml](file://docker-compose.yml#L20-L22)
- [Dockerfile](file://Dockerfile#L1-L112)

## 云服务器准备

### AWS EC2 实例配置

#### 实例类型选择
推荐以下实例类型：
- **通用型**: t3.large (2 vCPU, 8GB RAM) - 基础部署
- **计算优化型**: c5.xlarge (4 vCPU, 8GB RAM) - 性能平衡
- **内存优化型**: r5.xlarge (4 vCPU, 16GB RAM) - 运行本地 LLM
- **内存优化型**: r5.2xlarge (8 vCPU, 64GB RAM) - 大规模部署

#### 实例创建步骤
1. 登录 AWS 控制台
2. 导航到 EC2 服务
3. 点击 "Launch Instance"
4. 选择 Ubuntu Server 22.04 LTS AMI
5. 选择推荐的实例类型（如 t3.large）
6. 配置存储：至少 50GB EBS
7. 配置安全组：允许 SSH、HTTP、HTTPS 访问
8. 启动实例并下载密钥对

### Google Cloud 实例配置

#### 实例规格选择
- **机器类型**: e2-standard-4 (4 vCPU, 16GB RAM)
- **操作系统**: Ubuntu 22.04 LTS
- **磁盘类型**: SSD 持久磁盘，50GB 或更大
- **防火墙**: 允许 HTTP/HTTPS 流量

#### 实例创建步骤
1. 登录 Google Cloud Console
2. 导航到 Compute Engine
3. 创建新实例
4. 选择 Ubuntu 22.04 LTS
5. 配置机器规格
6. 设置网络安全规则
7. 创建实例

### 其他 VPS 提供商

#### DigitalOcean Droplets
- 规格: 4GB RAM, 2 vCPU
- 存储: 80GB SSD
- 地区: 选择靠近用户的区域

#### Vultr Instances
- 规格: 4 vCPU, 8GB RAM
- 存储: 160GB NVMe
- 地区: 选择最优地理位置

**节来源**
- [docker-compose.yml](file://docker-compose.yml#L20-L22)

## 环境配置

### SSH 连接到服务器

```bash
# 使用私钥连接
ssh -i your-key.pem ubuntu@your-server-ip

# 或使用用户名密码（不推荐）
ssh ubuntu@your-server-ip
```

### 更新系统包

```bash
# 更新包列表
sudo apt update

# 安装更新
sudo apt upgrade -y

# 安装必要工具
sudo apt install -y curl git wget htop
```

### 创建非 root 用户（可选但推荐）

```bash
# 创建用户
sudo adduser deploy

# 添加到 sudo 组
sudo usermod -aG sudo deploy

# 切换到新用户
su - deploy
```

### 设置环境变量

```bash
# 创建环境变量文件
nano ~/.bashrc

# 添加以下内容
export DEEPWIKI_HOME="/home/deploy/deepwiki"
export PATH="$PATH:/home/deploy/.local/bin"

# 应用更改
source ~/.bashrc
```

**节来源**
- [api/main.py](file://api/main.py#L1-L80)
- [api/config.py](file://api/config.py#L1-L200)

## Docker 安装与配置

### 安装 Docker

```bash
# 更新包索引
sudo apt update

# 安装依赖
sudo apt install -y \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

# 添加 Docker GPG 密钥
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# 添加 Docker 仓库
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# 安装 Docker
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io

# 验证安装
sudo docker --version
```

### 安装 Docker Compose

```bash
# 下载 Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

# 设置执行权限
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker-compose --version
```

### 配置 Docker 权限

```bash
# 将用户添加到 docker 组
sudo usermod -aG docker $USER

# 重新登录或执行
newgrp docker

# 测试 Docker 权限
docker run hello-world
```

### 配置 Docker 资源限制

编辑 Docker 配置文件：

```bash
# 编辑 Docker daemon 配置
sudo nano /etc/docker/daemon.json

# 添加资源限制配置
{
  "default-ulimits": {
    "nofile": {
      "soft": 65536,
      "hard": 65536
    },
    "memlock": {
      "soft": -1,
      "hard": -1
    }
  },
  "max-concurrent-downloads": 3,
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}

# 重启 Docker 服务
sudo systemctl restart docker
```

**节来源**
- [docker-compose.yml](file://docker-compose.yml#L1-L30)
- [Dockerfile](file://Dockerfile#L1-L112)

## 项目部署

### 克隆仓库

```bash
# 创建项目目录
mkdir -p ~/deepwiki
cd ~/deepwiki

# 克隆仓库
git clone https://github.com/AsyncFuncAI/deepwiki-open.git .
cd deepwiki-open

# 查看可用分支
git branch -a
```

### 创建环境配置文件

```bash
# 创建 .env 文件
nano .env

# 填写必要的 API 密钥
GOOGLE_API_KEY=your_google_api_key_here
OPENAI_API_KEY=your_openai_api_key_here
# 可选：使用 Google AI 嵌入模型
DEEPWIKI_EMBEDDER_TYPE=google
# 可选：添加 OpenRouter API 密钥
OPENROUTER_API_KEY=your_openrouter_api_key
# 可选：添加 Azure OpenAI 凭据
AZURE_OPENAI_API_KEY=your_azure_key
AZURE_OPENAI_ENDPOINT=your_azure_endpoint
AZURE_OPENAI_VERSION=2024-02-15-preview
# 可选：配置 Ollama 主机
OLLAMA_HOST=http://localhost:11434
```

### 环境变量配置详解

| 变量名 | 描述 | 是否必需 | 默认值 |
|--------|------|----------|--------|
| `GOOGLE_API_KEY` | Google Gemini API 密钥 | 是 | 无 |
| `OPENAI_API_KEY` | OpenAI API 密钥 | 是 | 无 |
| `OPENROUTER_API_KEY` | OpenRouter API 密钥 | 否 | 无 |
| `AZURE_OPENAI_API_KEY` | Azure OpenAI API 密钥 | 否 | 无 |
| `AZURE_OPENAI_ENDPOINT` | Azure OpenAI 端点 | 否 | 无 |
| `AZURE_OPENAI_VERSION` | Azure OpenAI 版本 | 否 | 无 |
| `OLLAMA_HOST` | Ollama 主机地址 | 否 | http://localhost:11434 |
| `DEEPWIKI_EMBEDDER_TYPE` | 嵌入模型类型 | 否 | openai |
| `PORT` | API 端口 | 否 | 8001 |
| `SERVER_BASE_URL` | 服务器基础 URL | 否 | http://localhost:8001 |

### 配置文件管理

```bash
# 创建配置目录
mkdir -p ~/.adalflow

# 设置数据持久化
docker volume create deepwiki-data

# 验证卷创建
docker volume ls
```

**节来源**
- [README.md](file://README.md#L35-L83)
- [api/config.py](file://api/config.py#L18-L64)

## 服务启动

### 启动应用程序

```bash
# 使用 Docker Compose 启动
cd ~/deepwiki/deepwiki-open
docker-compose up -d

# 或使用自定义脚本
./run.sh
```

### 服务状态检查

```bash
# 查看容器状态
docker ps

# 查看日志
docker-compose logs -f deepwiki

# 检查健康检查
docker inspect --format='{{.State.Health.Status}}' deepwiki-open_deepwiki_1
```

### 手动启动方式

```bash
# 构建镜像
docker build -t deepwiki-open .

# 运行容器
docker run -d \
  --name deepwiki \
  -p 8001:8001 \
  -p 3000:3000 \
  -v ~/.adalflow:/root/.adalflow \
  -v $(pwd)/.env:/app/.env \
  -e GOOGLE_API_KEY=$GOOGLE_API_KEY \
  -e OPENAI_API_KEY=$OPENAI_API_KEY \
  deepwiki-open
```

### 资源限制配置

```yaml
# docker-compose.yml 中的资源限制配置
services:
  deepwiki:
    mem_limit: 6g          # 内存上限
    mem_reservation: 2g    # 内存预留
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
```

**节来源**
- [docker-compose.yml](file://docker-compose.yml#L20-L28)
- [Dockerfile](file://Dockerfile#L82-L112)
- [run.sh](file://run.sh#L1-L1)

## 端口配置与安全组

### 端口映射说明

DeepWiki 使用以下端口：
- **3000**: Next.js 前端应用
- **8001**: FastAPI 后端服务

### AWS EC2 安全组配置

```bash
# 允许 SSH 访问
aws ec2 authorize-security-group-ingress \
    --group-id sg-xxxxxxxx \
    --protocol tcp \
    --port 22 \
    --cidr 0.0.0.0/0

# 允许 HTTP 访问
aws ec2 authorize-security-group-ingress \
    --group-id sg-xxxxxxxx \
    --protocol tcp \
    --port 80 \
    --cidr 0.0.0.0/0

# 允许 HTTPS 访问
aws ec2 authorize-security-group-ingress \
    --group-id sg-xxxxxxxx \
    --protocol tcp \
    --port 443 \
    --cidr 0.0.0.0/0

# 允许 DeepWiki 端口
aws ec2 authorize-security-group-ingress \
    --group-id sg-xxxxxxxx \
    --protocol tcp \
    --port 3000 \
    --cidr 0.0.0.0/0

aws ec2 authorize-security-group-ingress \
    --group-id sg-xxxxxxxx \
    --protocol tcp \
    --port 8001 \
    --cidr 0.0.0.0/0
```

### Google Cloud 防火墙规则

```bash
# 创建防火墙规则
gcloud compute firewall-rules create deepwiki-http \
    --allow tcp:80 \
    --target-tags deepwiki \
    --source-ranges 0.0.0.0/0 \
    --description "Allow HTTP traffic"

gcloud compute firewall-rules create deepwiki-https \
    --allow tcp:443 \
    --target-tags deepwiki \
    --source-ranges 0.0.0.0/0 \
    --description "Allow HTTPS traffic"

gcloud compute firewall-rules create deepwiki-app \
    --allow tcp:3000,tcp:8001 \
    --target-tags deepwiki \
    --source-ranges 0.0.0.0/0 \
    --description "Allow DeepWiki app traffic"
```

### 验证端口连通性

```bash
# 检查端口是否开放
telnet your-server-ip 3000
telnet your-server-ip 8001

# 使用 curl 测试
curl -I http://your-server-ip:3000
curl -I http://your-server-ip:8001/health

# 检查所有监听端口
sudo netstat -tlnp | grep LISTEN
```

**节来源**
- [docker-compose.yml](file://docker-compose.yml#L6-L8)
- [Dockerfile](file://Dockerfile#L79-L80)

## 常见问题排查

### 端口冲突问题

```bash
# 检查端口占用
sudo netstat -tlnp | grep :3000
sudo netstat -tlnp | grep :8001

# 查找占用进程
sudo lsof -i :3000
sudo lsof -i :8001

# 停止占用进程
sudo kill -9 PID_NUMBER

# 修改端口配置
nano docker-compose.yml
# 将 3000:3000 改为 3001:3000
# 将 8001:8001 改为 8002:8001
```

### 权限不足问题

```bash
# 检查文件权限
ls -la ~/.adalflow

# 修复权限
sudo chown -R $USER:$USER ~/.adalflow
sudo chmod -R 755 ~/.adalflow

# 检查 Docker 权限
docker ps
# 如果显示权限错误，重新配置 Docker 组
sudo usermod -aG docker $USER
newgrp docker
```

### API 密钥未设置问题

```bash
# 检查环境变量
cat .env
export GOOGLE_API_KEY
export OPENAI_API_KEY

# 验证 API 密钥有效性
curl -H "Authorization: Bearer $OPENAI_API_KEY" \
     https://api.openai.com/v1/models

# 重新加载环境变量
source .env
docker-compose down
docker-compose up -d
```

### 内存不足问题

```bash
# 检查内存使用情况
free -h
docker stats

# 调整 Docker 内存限制
# 编辑 docker-compose.yml
services:
  deepwiki:
    mem_limit: 8g
    mem_reservation: 4g

# 重新启动服务
docker-compose down
docker-compose up -d
```

### 日志分析

```bash
# 查看容器日志
docker-compose logs deepwiki

# 实时查看日志
docker-compose logs -f deepwiki

# 查看特定时间的日志
docker-compose logs --since="2024-01-01T00:00:00" deepwiki

# 检查系统日志
sudo journalctl -u docker.service
sudo journalctl -u docker-compose
```

### 网络连接问题

```bash
# 测试外部连接
ping api.openai.com
ping api.gemini.com

# 检查 DNS 解析
nslookup api.openai.com

# 测试 API 可访问性
curl -X POST https://api.openai.com/v1/chat/completions \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer $OPENAI_API_KEY" \
     -d '{"model": "gpt-3.5-turbo", "messages": [{"role": "user", "content": "test"}]}'
```

### 数据持久化问题

```bash
# 检查数据卷
docker volume ls
docker volume inspect deepwiki-data

# 验证数据目录
ls -la ~/.adalflow/

# 备份重要数据
tar -czvf backup.tar.gz ~/.adalflow/
```

**节来源**
- [api/main.py](file://api/main.py#L47-L52)
- [README.md](file://README.md#L615-L652)

## 监控与维护

### 服务监控

```bash
# 创建监控脚本
nano monitor_deepwiki.sh
#!/bin/bash

# 检查容器状态
if ! docker ps --format '{{.Names}}' | grep -q deepwiki; then
    echo "$(date): DeepWiki container is not running. Restarting..."
    cd ~/deepwiki/deepwiki-open && docker-compose up -d
fi

# 检查 API 健康状态
if ! curl -f http://localhost:8001/health >/dev/null 2>&1; then
    echo "$(date): DeepWiki API is not responding. Restarting..."
    cd ~/deepwiki/deepwiki-open && docker-compose restart deepwiki
fi

# 检查内存使用
MEMORY_USAGE=$(docker stats --no-stream --format "table {{.MemUsage}}" deepwiki | head -1 | cut -d '/' -f1 | sed 's/MiB//')
if [ "$MEMORY_USAGE" -gt 5000 ]; then
    echo "$(date): Memory usage is high: ${MEMORY_USAGE}MiB"
fi
```

### 自动化维护

```bash
# 创建定时任务
crontab -e

# 添加以下内容
# 每天凌晨 2 点检查服务状态
0 2 * * * /home/deploy/monitor_deepwiki.sh

# 每小时清理旧日志
0 * * * * find /home/deploy/deepwiki/deepwiki-open/api/logs -name "*.log" -mtime +7 -delete

# 每周更新 Docker 镜像
0 3 * * 0 cd /home/deploy/deepwiki/deepwiki-open && git pull && docker-compose build && docker-compose up -d
```

### 备份策略

```bash
# 创建备份脚本
nano backup_deepwiki.sh
#!/bin/bash

BACKUP_DIR="/backup/deepwiki/$(date +%Y%m%d)"
mkdir -p $BACKUP_DIR

# 备份配置文件
cp -r ~/.adalflow $BACKUP_DIR/
cp docker-compose.yml $BACKUP_DIR/
cp .env $BACKUP_DIR/

# 压缩备份
tar -czvf $BACKUP_DIR.tar.gz $BACKUP_DIR
rm -rf $BACKUP_DIR

# 清理旧备份（保留 30 天）
find /backup/deepwiki -name "*.tar.gz" -mtime +30 -delete
```

### 性能优化

```bash
# 优化 Docker 配置
# /etc/docker/daemon.json
{
  "storage-driver": "overlay2",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  },
  "registry-mirrors": ["https://mirror.gcr.io"],
  "insecure-registries": [],
  "debug": false,
  "experimental": false
}

# 重启 Docker 服务
sudo systemctl restart docker

# 优化系统参数
# /etc/sysctl.conf
net.core.somaxconn = 1024
net.ipv4.tcp_max_syn_backlog = 2048
vm.swappiness = 10
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5

# 应用更改
sudo sysctl -p
```

### 故障恢复

```bash
# 服务故障恢复脚本
nano recover_deepwiki.sh
#!/bin/bash

echo "Starting DeepWiki recovery process..."

# 停止所有相关容器
docker-compose down

# 清理网络和卷
docker network prune -f
docker volume prune -f

# 删除旧镜像
docker images | grep deepwiki | awk '{print $3}' | xargs docker rmi -f

# 重新构建和启动
cd ~/deepwiki/deepwiki-open
git pull
docker-compose build
docker-compose up -d

# 等待服务启动
sleep 30

# 验证服务状态
if docker ps --format '{{.Names}}' | grep -q deepwiki; then
    echo "DeepWiki recovery successful!"
    docker-compose logs -n 50 deepwiki
else
    echo "DeepWiki recovery failed. Check logs for details."
    docker-compose logs deepwiki
fi
```

**节来源**
- [docker-compose.yml](file://docker-compose.yml#L24-L29)
- [api/logging_config.py](file://api/logging_config.py)

## 结论

本指南提供了在各种云平台上部署 DeepWiki 的完整流程，涵盖了从服务器准备到日常维护的所有关键步骤。通过遵循这些步骤，您可以成功地在生产环境中运行 DeepWiki，为用户提供强大的 AI 驱动的代码文档生成功能。

关键要点：
- 选择合适的硬件配置以确保最佳性能
- 正确配置安全组和防火墙规则
- 实施适当的监控和备份策略
- 定期维护和更新系统组件

定期检查更新和安全补丁，确保 DeepWiki 始终处于最佳运行状态。