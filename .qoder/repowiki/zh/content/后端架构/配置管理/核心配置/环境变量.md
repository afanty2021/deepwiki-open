# 环境变量

<cite>
**本文档中引用的文件**   
- [config.py](file://api/config.py)
- [main.py](file://api/main.py)
- [api.py](file://api/api.py)
- [embedder.json](file://api/config/embedder.json)
- [generator.json](file://api/config/generator.json)
- [lang.json](file://api/config/lang.json)
- [repo.json](file://api/config/repo.json)
- [openai_client.py](file://api/openai_client.py)
- [google_embedder_client.py](file://api/google_embedder_client.py)
- [azureai_client.py](file://api/azureai_client.py)
- [bedrock_client.py](file://api/bedrock_client.py)
- [dashscope_client.py](file://api/dashscope_client.py)
</cite>

## 目录
1. [简介](#简介)
2. [核心环境变量](#核心环境变量)
3. [敏感密钥注入机制](#敏感密钥注入机制)
4. [环境变量与配置文件优先级](#环境变量与配置文件优先级)
5. [配置文件结构](#配置文件结构)
6. [环境变量使用示例](#环境变量使用示例)

## 简介

deepwiki-open 项目通过环境变量提供灵活的配置选项，允许用户在不修改代码的情况下自定义系统行为。环境变量用于控制维基访问认证模式、指定嵌入模型类型、设置API密钥以及自定义配置文件加载路径等关键功能。本文档详细说明了这些环境变量的用途、默认值和使用方法。

**Section sources**
- [config.py](file://api/config.py#L1-L388)
- [main.py](file://api/main.py#L1-L80)

## 核心环境变量

### DEEPWIKI_AUTH_MODE：维基访问认证模式

`DEEPWIKI_AUTH_MODE` 环境变量用于控制维基系统的访问认证模式。当设置为 `true` 或 `1` 时，系统将启用授权模式，要求用户提供有效的授权码才能访问某些功能。

在代码中，该变量通过 `os.environ.get()` 方法读取，并转换为布尔值：

```python
raw_auth_mode = os.environ.get('DEEPWIKI_AUTH_MODE', 'False')
WIKI_AUTH_MODE = raw_auth_mode.lower() in ['true', '1', 't']
```

当认证模式启用时，前端会显示一个输入字段供用户输入授权码，同时保护已生成页面的缓存删除功能。

**Section sources**
- [config.py](file://api/config.py#L43-L45)
- [api.py](file://api/api.py#L147-L165)

### DEEPWIKI_AUTH_CODE：访问密钥设置

`DEEPWIKI_AUTH_CODE` 环境变量用于设置访问密钥，该密钥在 `DEEPWIKI_AUTH_MODE` 启用时作为验证凭据。用户必须输入与该环境变量值匹配的代码才能完成认证。

该变量的读取方式如下：

```python
WIKI_AUTH_CODE = os.environ.get('DEEPWIKI_AUTH_CODE', '')
```

在API端点中，系统会验证提供的授权码是否与环境变量中的值匹配：

```python
@app.post("/auth/validate")
async def validate_auth_code(request: AuthorizationConfig):
    return {"success": WIKI_AUTH_CODE == request.code}
```

**Section sources**
- [config.py](file://api/config.py#L46)
- [api.py](file://api/api.py#L160-L165)

### DEEPWIKI_EMBEDDER_TYPE：嵌入模型类型指定

`DEEPWIKI_EMBEDDER_TYPE` 环境变量用于指定嵌入模型的类型，支持 `openai`、`google` 和 `ollama` 三种选项，默认值为 `openai`。

该变量的读取和处理方式如下：

```python
EMBEDDER_TYPE = os.environ.get('DEEPWIKI_EMBEDDER_TYPE', 'openai').lower()
```

根据该变量的值，系统会选择相应的嵌入模型配置：

```python
def get_embedder_config():
    embedder_type = EMBEDDER_TYPE
    if embedder_type == 'google' and 'embedder_google' in configs:
        return configs.get("embedder_google", {})
    elif embedder_type == 'ollama' and 'embedder_ollama' in configs:
        return configs.get("embedder_ollama", {})
    else:
        return configs.get("embedder", {})
```

**Section sources**
- [config.py](file://api/config.py#L49)
- [config.py](file://api/config.py#L160-L173)

### DEEPWIKI_CONFIG_DIR：配置文件加载路径自定义

`DEEPWIKI_CONFIG_DIR` 环境变量允许用户自定义配置文件的加载路径。如果未设置该变量，系统将使用默认的 `api/config/` 目录。

该变量的使用方式如下：

```python
CONFIG_DIR = os.environ.get('DEEPWIKI_CONFIG_DIR', None)

def load_json_config(filename):
    if CONFIG_DIR:
        config_path = Path(CONFIG_DIR) / filename
    else:
        config_path = Path(__file__).parent / "config" / filename
```

这使得用户可以在不同环境中灵活地管理配置文件位置。

**Section sources**
- [config.py](file://api/config.py#L51-L52)
- [config.py](file://api/config.py#L96-L115)

## 敏感密钥注入机制

### API密钥环境变量

系统通过环境变量注入多种敏感密钥，包括：

- `OPENAI_API_KEY`：OpenAI API密钥
- `GOOGLE_API_KEY`：Google API密钥
- `OPENROUTER_API_KEY`：OpenRouter API密钥
- `AWS_ACCESS_KEY_ID`：AWS访问密钥ID
- `AWS_SECRET_ACCESS_KEY`：AWS秘密访问密钥

这些密钥在 `config.py` 文件中通过 `os.environ.get()` 方法读取：

```python
OPENAI_API_KEY = os.environ.get('OPENAI_API_KEY')
GOOGLE_API_KEY = os.environ.get('GOOGLE_API_KEY')
OPENROUTER_API_KEY = os.environ.get('OPENROUTER_API_KEY')
AWS_ACCESS_KEY_ID = os.environ.get('AWS_ACCESS_KEY_ID')
AWS_SECRET_ACCESS_KEY = os.environ.get('AWS_SECRET_ACCESS_KEY')
```

### 自动注入逻辑

系统不仅读取环境变量，还会将这些密钥重新设置到环境变量中，确保它们在整个应用程序中可用：

```python
if OPENAI_API_KEY:
    os.environ["OPENAI_API_KEY"] = OPENAI_API_KEY
if GOOGLE_API_KEY:
    os.environ["GOOGLE_API_KEY"] = GOOGLE_API_KEY
if OPENROUTER_API_KEY:
    os.environ["OPENROUTER_API_KEY"] = OPENROUTER_API_KEY
if AWS_ACCESS_KEY_ID:
    os.environ["AWS_ACCESS_KEY_ID"] = AWS_ACCESS_KEY_ID
if AWS_SECRET_ACCESS_KEY:
    os.environ["AWS_SECRET_ACCESS_KEY"] = AWS_SECRET_ACCESS_KEY
```

这种双重设置确保了密钥在不同组件间的传递和使用。

**Section sources**
- [config.py](file://api/config.py#L18-L41)
- [main.py](file://api/main.py#L48-L53)

### 客户端特定密钥处理

不同客户端对密钥的处理方式略有不同。例如，Azure AI客户端使用特定的环境变量：

```python
api_key = self._api_key or os.getenv("AZURE_OPENAI_API_KEY")
azure_endpoint = self._azure_endpoint or os.getenv("AZURE_OPENAI_ENDPOINT")
api_version = self._apiversion or os.getenv("AZURE_OPENAI_VERSION")
```

而AWS Bedrock客户端则使用AWS特定的环境变量：

```python
from api.config import AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_REGION, AWS_ROLE_ARN
```

**Section sources**
- [azureai_client.py](file://api/azureai_client.py#L233-L235)
- [bedrock_client.py](file://api/bedrock_client.py#L56-L61)

## 环境变量与配置文件优先级

### 配置加载机制

系统采用环境变量优先的配置加载机制。环境变量可以动态覆盖静态JSON配置文件中的值。

配置文件加载过程如下：

```python
def load_json_config(filename):
    if CONFIG_DIR:
        config_path = Path(CONFIG_DIR) / filename
    else:
        config_path = Path(__file__).parent / "config" / filename
```

### 环境变量占位符替换

系统支持在JSON配置文件中使用环境变量占位符 `${ENV_VAR}`，这些占位符会在运行时被实际的环境变量值替换：

```python
def replace_env_placeholders(config):
    pattern = re.compile(r"\$\{([A-Z0-9_]+)\}")
    
    def replacer(match):
        env_var_name = match.group(1)
        env_var_value = os.environ.get(env_var_name)
        if env_var_value is None:
            logger.warning(f"Environment variable placeholder '{match.group(0)}' was not found")
            return match.group(0)
        return env_var_value
    
    if isinstance(config, dict):
        return {k: replace_env_placeholders(v) for k, v in config.items()}
    elif isinstance(config, str):
        return pattern.sub(replacer, config)
    else:
        return config
```

当加载配置文件时，系统会自动调用此函数进行占位符替换：

```python
def load_json_config(filename):
    # ... 加载文件 ...
    config = json.load(f)
    config = replace_env_placeholders(config)
    return config
```

**Section sources**
- [config.py](file://api/config.py#L66-L94)
- [config.py](file://api/config.py#L114)

## 配置文件结构

### generator.json：生成器配置

`generator.json` 文件定义了文本生成模型的配置，包括可用的模型提供商、默认和可用模型以及模型特定参数。

```json
{
  "default_provider": "google",
  "providers": {
    "google": {
      "default_model": "gemini-2.5-flash",
      "models": {
        "gemini-2.5-flash": {
          "temperature": 1.0,
          "top_p": 0.8,
          "top_k": 20
        }
      }
    }
  }
}
```

**Section sources**
- [generator.json](file://api/config/generator.json)

### embedder.json：嵌入模型配置

`embedder.json` 文件定义了嵌入模型和文本处理配置，包括用于向量存储的嵌入模型、RAG检索器配置和文本分割器设置。

```json
{
  "embedder": {
    "client_class": "OpenAIClient",
    "model_kwargs": {
      "model": "text-embedding-3-small",
      "dimensions": 256,
      "encoding_format": "float"
    }
  },
  "embedder_ollama": {
    "client_class": "OllamaClient",
    "model_kwargs": {
      "model": "nomic-embed-text"
    }
  },
  "retriever": {
    "top_k": 20
  },
  "text_splitter": {
    "split_by": "word",
    "chunk_size": 350,
    "chunk_overlap": 100
  }
}
```

**Section sources**
- [embedder.json](file://api/config/embedder.json)

### repo.json：仓库处理配置

`repo.json` 文件包含仓库处理配置，包括文件过滤器和仓库大小限制。

```json
{
  "file_filters": {
    "excluded_dirs": [
      "./.venv/",
      "./node_modules/",
      "./.git/"
    ],
    "excluded_files": [
      "yarn.lock",
      ".env",
      "*.pyc"
    ]
  },
  "repository": {
    "max_size_mb": 50000
  }
}
```

**Section sources**
- [repo.json](file://api/config/repo.json)

### lang.json：语言配置

`lang.json` 文件定义了支持的语言和默认语言设置。

```json
{
  "supported_languages": {
    "en": "English",
    "ja": "Japanese (日本語)",
    "zh": "Mandarin Chinese (中文)"
  },
  "default": "en"
}
```

**Section sources**
- [lang.json](file://api/config/lang.json)

## 环境变量使用示例

### 基本用法

在启动应用前设置环境变量：

```bash
export DEEPWIKI_AUTH_MODE=true
export DEEPWIKI_AUTH_CODE=mysecretpassword
export DEEPWIKI_EMBEDDER_TYPE=google
export GOOGLE_API_KEY=your_google_api_key_here
export OPENAI_API_KEY=your_openai_api_key_here
```

### Docker环境变量

在Docker环境中使用环境变量：

```dockerfile
ENV DEEPWIKI_AUTH_MODE=true
ENV DEEPWIKI_AUTH_CODE=mysecretpassword
ENV DEEPWIKI_EMBEDDER_TYPE=google
ENV GOOGLE_API_KEY=${GOOGLE_API_KEY}
ENV OPENAI_API_KEY=${OPENAI_API_KEY}
```

或者在 `docker-compose.yml` 中：

```yaml
environment:
  - DEEPWIKI_AUTH_MODE=true
  - DEEPWIKI_AUTH_CODE=mysecretpassword
  - DEEPWIKI_EMBEDDER_TYPE=google
  - GOOGLE_API_KEY=${GOOGLE_API_KEY}
  - OPENAI_API_KEY=${OPENAI_API_KEY}
```

### 配置文件占位符使用

在 `generator.json` 中使用环境变量占位符：

```json
{
  "providers": {
    "openai": {
      "api_key": "${OPENAI_API_KEY}",
      "base_url": "${OPENAI_BASE_URL}"
    }
  }
}
```

这样可以在不同环境中使用不同的API端点，而无需修改配置文件。

**Section sources**
- [README.md](file://README.md#L400-L438)
- [README.zh.md](file://README.zh.md#L320-L350)
- [config.py](file://api/config.py#L66-L94)