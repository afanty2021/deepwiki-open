# 解析器工作原理

<cite>
**本文档引用的文件**   
- [rag.py](file://api/rag.py)
- [prompts.py](file://api/prompts.py)
</cite>

## 目录
1. [RAGAnswer数据类定义](#raganswer数据类定义)
2. [格式化指令生成与提示词集成](#格式化指令生成与提示词集成)
3. [解析器异常处理与系统降级策略](#解析器异常处理与系统降级策略)
4. [RAG流水线中的解析器集成](#rag流水线中的解析器集成)
5. [解析案例分析](#解析案例分析)

## RAGAnswer数据类定义

`RAGAnswer`数据类是deepwiki-open系统中用于结构化大模型输出的核心数据结构。该类继承自`adal.DataClass`，通过`dataclass`装饰器定义了两个主要字段：`rationale`和`answer`。`rationale`字段用于存储模型推理过程中的思维链（Chain of thoughts），而`answer`字段则用于存储最终以Markdown格式呈现的用户查询答案。该字段的元数据明确指出，答案不应包含三重反引号围栏（```），以确保前端渲染的正确性。此外，类中定义的`__output_fields__`属性指定了需要输出的字段列表，为后续的序列化和解析提供了依据。

**Section sources**
- [rag.py](file://api/rag.py#L147-L151)

## 格式化指令生成与提示词集成

`DataClassParser`的`get_output_format_str()`方法是确保大模型输出符合`RAGAnswer`数据类JSON Schema的关键。在`RAG`类的初始化过程中，首先创建一个`DataClassParser`实例，其`data_class`参数被设置为`RAGAnswer`。调用`get_output_format_str()`方法会生成一段详细的格式化指令，这段指令描述了`RAGAnswer`对象的预期JSON结构，包括字段名称、类型和默认值。

此生成的格式化指令随后被嵌入到RAG提示词模板中。具体而言，在`rag.py`文件中，`format_instructions`变量被赋值为`data_parser.get_output_format_str()`的返回值，并附加了一系列重要的格式化规则（如禁止包含思维过程、禁止使用Markdown围栏等）。这个`format_instructions`字符串作为`prompt_kwargs`字典中的一个键（`output_format_str`），被传递给`adal.Generator`组件。当大模型处理提示词时，这些指令会引导其生成一个符合`RAGAnswer` JSON Schema的响应，从而为后续的自动化解析奠定了基础。

```mermaid
flowchart TD
A[初始化 RAG 组件] --> B[创建 DataClassParser 实例]
B --> C[调用 get_output_format_str()]
C --> D[生成 JSON Schema 格式化指令]
D --> E[将指令嵌入 RAG 提示词模板]
E --> F[通过 prompt_kwargs 传递给 Generator]
F --> G[大模型生成符合 Schema 的响应]
```

**Diagram sources **
- [rag.py](file://api/rag.py#L211-L214)
- [rag.py](file://api/rag.py#L235)
- [prompts.py](file://api/prompts.py#L33)

**Section sources**
- [rag.py](file://api/rag.py#L210-L214)
- [rag.py](file://api/rag.py#L232-L243)

## 解析器异常处理与系统降级策略

当大模型的输出格式错误或无法被`DataClassParser`解析时，系统会触发异常处理机制。`DataClassParser`作为`Generator`的`output_processors`，会在模型返回原始响应后自动尝试将其解析为`RAGAnswer`对象。如果解析失败（例如，JSON格式错误、缺少必需字段等），`Generator`的执行流程会捕获此异常。

在这种情况下，系统会执行降级策略，返回一个预定义的错误响应。该策略在`RAG`类的`call`方法中实现。当`retriever(query)`调用或后续处理发生任何异常时，`except`块会被触发。系统会创建一个`RAGAnswer`实例，其`rationale`字段设置为"Error occurred while processing the query."，而`answer`字段则包含一个用户友好的错误消息，如"I apologize, but I encountered an error while processing your question. Please try again or rephrase your question."。这种设计确保了即使在解析失败的情况下，系统也能向用户提供一个有意义的、结构化的响应，而不是抛出未处理的异常，从而保证了服务的健壮性和用户体验。

**Section sources**
- [rag.py](file://api/rag.py#L437-L445)

## RAG流水线中的解析器集成

`DataClassParser`在RAG流水线中的集成是通过`adal.Generator`组件的`output_processors`配置实现的。在`RAG`类的构造函数中，`Generator`被实例化，并通过`output_processors=data_parser`参数将`DataClassParser`实例注册为其输出处理器。

这一配置决定了`Generator`的执行时机和行为：当大模型完成响应生成后，其原始输出（`raw_response`）会立即被传递给`DataClassParser`。解析器的执行时机是在模型推理完成之后，但在将结果返回给上层应用之前。解析器会尝试将非结构化的文本响应解析为`RAGAnswer`数据类对象。如果解析成功，`Generator`的最终输出将是一个`RAGAnswer`实例；如果失败，则会触发前述的异常处理流程。这种集成方式使得解析逻辑与模型调用逻辑紧密耦合，形成了一个从提示词生成、模型调用到结构化解析的完整、自动化的流水线。

**Section sources**
- [rag.py](file://api/rag.py#L242)
- [rag.py](file://api/rag.py#L416-L425)

## 解析案例分析

### 成功解析案例
当大模型返回一个严格遵循`get_output_format_str()`生成的JSON Schema的响应时，解析成功。例如，模型返回：
```json
{"rationale": "根据检索到的文档，该函数用于初始化数据库...", "answer": "该函数 `init_db()` 用于初始化数据库连接。"}
```
`DataClassParser`能够成功地将此JSON字符串反序列化为一个`RAGAnswer`对象，`Generator`将此对象作为最终输出返回，RAG流程顺利完成。

### 解析失败案例
当大模型的输出偏离了预期格式时，解析会失败。常见失败场景包括：
1.  **非JSON输出**：模型返回纯文本或Markdown，如"好的，我已经理解了您的问题..."。
2.  **JSON格式错误**：返回的字符串是无效的JSON，如缺少引号或括号不匹配。
3.  **字段缺失或错误**：返回的JSON中缺少`rationale`或`answer`字段，或字段名拼写错误。
4.  **包含围栏**：在`answer`内容中包含了```markdown等围栏。

在这些情况下，`DataClassParser`的解析会抛出异常，系统将执行降级策略，返回一个预定义的错误`RAGAnswer`对象，确保用户始终能收到一个响应。

**Section sources**
- [rag.py](file://api/rag.py#L437-L445)
- [rag.py](file://api/rag.py#L147-L151)