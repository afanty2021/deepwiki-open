# 配置与定制

<cite>
**本文档中引用的文件**
- [api/config/embedder.json](file://api/config/embedder.json)
- [api/config/generator.json](file://api/config/generator.json)
- [api/config/lang.json](file://api/config/lang.json)
- [api/config/repo.json](file://api/config/repo.json)
- [api/config.py](file://api/config.py)
- [Dockerfile](file://Dockerfile)
- [docker-compose.yml](file://docker-compose.yml)
- [run.sh](file://run.sh)
- [api/main.py](file://api/main.py)
- [api/README.md](file://api/README.md)
- [README.md](file://README.md)
</cite>

## 目录
1. [简介](#简介)
2. [配置文件架构](#配置文件架构)
3. [核心配置文件详解](#核心配置文件详解)
4. [环境变量配置](#环境变量配置)
5. [容器化部署配置](#容器化部署配置)
6. [常见定制场景](#常见定制场景)
7. [配置验证与故障排除](#配置验证与故障排除)
8. [最佳实践](#最佳实践)

## 简介

DeepWiki是一个强大的知识库构建工具，提供了灵活的配置系统来满足不同环境和需求。本指南将详细介绍如何通过JSON配置文件和环境变量来定制系统行为，包括AI模型选择、语言设置、仓库处理参数等关键配置项。

系统采用模块化的配置设计，支持多种AI提供商、多语言界面、灵活的文件过滤机制，以及容器化部署选项。所有配置都可以通过环境变量进行覆盖，确保在不同环境中的一致性和灵活性。

## 配置文件架构

DeepWiki的配置系统基于JSON文件和环境变量的组合，提供了层次化的配置管理：

```mermaid
graph TB
subgraph "配置层次结构"
ENV[环境变量<br/>Environment Variables]
CONFIG_DIR[配置目录<br/>DEEPWIKI_CONFIG_DIR]
DEFAULT_CONFIG[默认配置文件<br/>api/config/]
end
subgraph "核心配置文件"
GENERATOR[generator.json<br/>生成模型配置]
EMBEDDER[embedder.json<br/>嵌入模型配置]
LANG[lang.json<br/>语言配置]
REPO[repo.json<br/>仓库处理配置]
end
subgraph "运行时配置"
LOADED_CONFIG[加载的配置<br/>Runtime Config]
VALIDATED_CONFIG[验证后的配置<br/>Validated Config]
end
ENV --> CONFIG_DIR
CONFIG_DIR --> DEFAULT_CONFIG
DEFAULT_CONFIG --> GENERATOR
DEFAULT_CONFIG --> EMBEDDER
DEFAULT_CONFIG --> LANG
DEFAULT_CONFIG --> REPO
GENERATOR --> LOADED_CONFIG
EMBEDDER --> LOADED_CONFIG
LANG --> LOADED_CONFIG
REPO --> LOADED_CONFIG
LOADED_CONFIG --> VALIDATED_CONFIG
```

**图表来源**
- [api/config.py](file://api/config.py#L96-L118)
- [api/config.py](file://api/config.py#L303-L332)

**章节来源**
- [api/config.py](file://api/config.py#L1-L50)

## 核心配置文件详解

### generator.json - 生成模型配置

生成器配置文件定义了所有可用的AI模型提供商及其参数设置：

| 配置项 | 类型 | 描述 | 默认值 |
|--------|------|------|--------|
| default_provider | string | 默认使用的AI提供商 | google |
| providers | object | 所有可用提供商的配置 | - |
| supportsCustomModel | boolean | 是否支持自定义模型 | - |
| models | object | 特定提供商下的可用模型 | - |
| temperature | float | 生成温度参数 | 0.7-1.0 |
| top_p | float | 核采样参数 | 0.8 |

**支持的提供商：**
- Google Gemini (gemini-2.5-flash系列)
- OpenAI (gpt-5系列、gpt-4o等)
- OpenRouter (支持多个第三方模型)
- Ollama (本地模型)
- AWS Bedrock (Claude、Titan等)
- Azure OpenAI (企业级部署)

**章节来源**
- [api/config/generator.json](file://api/config/generator.json#L1-L200)

### embedder.json - 嵌入模型配置

嵌入器配置文件管理向量嵌入相关的设置：

| 配置项 | 类型 | 描述 | 默认值 |
|--------|------|------|--------|
| client_class | string | 使用的客户端类 | OpenAIClient |
| batch_size | integer | 批处理大小 | 500 |
| model | string | 嵌入模型名称 | text-embedding-3-small |
| dimensions | integer | 向量维度 | 256 |
| top_k | integer | 检索返回的相似度项目数量 | 20 |
| split_by | string | 文本分割方式 | word |
| chunk_size | integer | 文本块大小 | 350 |
| chunk_overlap | integer | 文本块重叠大小 | 100 |

**支持的嵌入模型提供商：**
- OpenAI (text-embedding-3-small)
- Google Vertex AI (text-embedding-004)
- Ollama (nomic-embed-text)

**章节来源**
- [api/config/embedder.json](file://api/config/embedder.json#L1-L34)

### lang.json - 语言配置

语言配置文件定义了系统支持的语言选项：

| 配置项 | 类型 | 描述 | 支持的语言 |
|--------|------|------|------------|
| supported_languages | object | 支持的语言映射 | en, ja, zh, zh-tw, es, kr, vi, pt-br, fr, ru |
| default | string | 默认语言 | en |

**支持的语言列表：**
- English (en)
- Japanese (ja)
- Mandarin Chinese (zh)
- Traditional Chinese (zh-tw)
- Spanish (es)
- Korean (kr)
- Vietnamese (vi)
- Brazilian Portuguese (pt-br)
- French (fr)
- Russian (ru)

**章节来源**
- [api/config/lang.json](file://api/config/lang.json#L1-L16)

### repo.json - 仓库处理配置

仓库配置文件控制代码仓库的处理规则：

| 配置项 | 类型 | 描述 | 示例 |
|--------|------|------|------|
| excluded_dirs | array | 排除的目录模式 | .venv/, node_modules/, .git/ |
| excluded_files | array | 排除的文件模式 | *.lock, .env, *.min.js |
| max_size_mb | integer | 仓库最大大小(MB) | 50000 |

**默认排除规则：**
- 虚拟环境目录 (.venv/, venv/, .virtualenv/)
- 包管理器锁定文件 (*.lock)
- 构建输出目录 (dist/, build/, out/)
- 版本控制系统 (.git/, .svn/, .hg/)

**章节来源**
- [api/config/repo.json](file://api/config/repo.json#L1-L129)

## 环境变量配置

DeepWiki通过环境变量提供灵活的配置覆盖机制：

### 核心环境变量

| 变量名 | 描述 | 必需 | 默认值 |
|--------|------|------|--------|
| DEEPWIKI_CONFIG_DIR | 自定义配置目录路径 | 否 | None |
| DEEPWIKI_EMBEDDER_TYPE | 默认嵌入模型类型 | 否 | openai |
| DEEPWIKI_AUTH_MODE | 启用授权模式 | 否 | False |
| DEEPWIKI_AUTH_CODE | 授权码 | 否 | '' |

### API密钥配置

| 变量名 | 描述 | 提供商 |
|--------|------|--------|
| GOOGLE_API_KEY | Google Gemini API密钥 | Google |
| OPENAI_API_KEY | OpenAI API密钥 | OpenAI |
| OPENROUTER_API_KEY | OpenRouter API密钥 | OpenRouter |
| AZURE_OPENAI_API_KEY | Azure OpenAI API密钥 | Azure |
| AZURE_OPENAI_ENDPOINT | Azure OpenAI端点 | Azure |
| AZURE_OPENAI_VERSION | Azure OpenAI版本 | Azure |

### 服务配置

| 变量名 | 描述 | 默认值 |
|--------|------|--------|
| PORT | 服务端口 | 8001 |
| NODE_ENV | Node.js环境 | production |
| SERVER_BASE_URL | 服务器基础URL | http://localhost:8001 |
| LOG_LEVEL | 日志级别 | INFO |
| LOG_FILE_PATH | 日志文件路径 | api/logs/application.log |

### 高级配置选项

| 变量名 | 描述 | 示例 |
|--------|------|------|
| OPENAI_BASE_URL | 自定义OpenAI端点 | https://custom-endpoint.com/v1 |
| OLLAMA_HOST | Ollama主机地址 | http://localhost:11434 |
| AWS_ACCESS_KEY_ID | AWS访问密钥ID | AKIAIOSFODNN7EXAMPLE |
| AWS_SECRET_ACCESS_KEY | AWS秘密访问密钥 | wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY |
| AWS_REGION | AWS区域 | us-east-1 |
| AWS_ROLE_ARN | AWS角色ARN | arn:aws:iam::123456789012:role/S3Access |

**章节来源**
- [api/config.py](file://api/config.py#L18-L47)
- [api/main.py](file://api/main.py#L47-L52)

## 容器化部署配置

### Dockerfile配置

DeepWiki使用多阶段Docker构建来优化镜像大小和安全性：

```mermaid
graph LR
subgraph "构建阶段"
NODE_DEPS[Node依赖安装]
PY_DEPS[Python依赖安装]
NODE_BUILD[Node.js构建]
end
subgraph "最终镜像"
BASE_IMAGE[Python 3.11 Slim]
CERTS[证书更新]
COPY_DEPS[复制依赖]
COPY_APP[复制应用]
EXPOSE_PORTS[暴露端口]
end
NODE_DEPS --> NODE_BUILD
PY_DEPS --> BASE_IMAGE
NODE_BUILD --> BASE_IMAGE
CERTS --> COPY_DEPS
COPY_DEPS --> COPY_APP
COPY_APP --> EXPOSE_PORTS
```

**图表来源**
- [Dockerfile](file://Dockerfile#L1-L112)

**关键特性：**
- 多阶段构建减少镜像大小
- 自动证书更新支持
- 环境变量自动加载
- 健康检查配置

### docker-compose.yml配置

容器编排配置提供了完整的部署环境：

| 配置项 | 值 | 描述 |
|--------|-----|------|
| ports | 8001:8001, 3000:3000 | API和前端端口映射 |
| env_file | .env | 环境变量文件 |
| volumes | ~/.adalflow:/root/.adalflow | 数据持久化 |
| mem_limit | 6g | 内存限制 |
| healthcheck | curl请求检查 | 健康状态监控 |

**章节来源**
- [Dockerfile](file://Dockerfile#L1-L112)
- [docker-compose.yml](file://docker-compose.yml#L1-L30)

## 常见定制场景

### 场景1：更换默认AI提供商

**步骤：**
1. 修改generator.json中的default_provider
2. 设置对应的API密钥
3. 重启服务

**配置示例：**
```json
{
  "default_provider": "openai",
  "providers": {
    "openai": {
      "default_model": "gpt-4o",
      "supportsCustomModel": true
    }
  }
}
```

### 场景2：调整向量数据库存储路径

**方法：**
1. 设置DEEPWIKI_CONFIG_DIR环境变量
2. 复制配置文件到新位置
3. 修改embedder.json中的相关路径

### 场景3：启用调试日志

**配置：**
```bash
export LOG_LEVEL=DEBUG
export LOG_FILE_PATH=/app/api/logs/debug.log
```

### 场景4：限制并发请求数

**Docker Compose配置：**
```yaml
services:
  deepwiki:
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
```

### 场景5：自定义文件过滤规则

**修改repo.json：**
```json
{
  "file_filters": {
    "excluded_dirs": [
      "./.venv/",
      "./node_modules/",
      "./custom-exclude/"
    ],
    "excluded_files": [
      "*.lock",
      "*.custom-ext"
    ]
  }
}
```

## 配置验证与故障排除

### 配置加载验证

系统启动时会执行以下验证步骤：

```mermaid
flowchart TD
START[系统启动] --> LOAD_ENV[加载环境变量]
LOAD_ENV --> CHECK_KEYS{检查API密钥}
CHECK_KEYS --> |缺失| WARN_MISSING[记录警告]
CHECK_KEYS --> |完整| LOAD_CONFIG[加载配置文件]
WARN_MISSING --> LOAD_CONFIG
LOAD_CONFIG --> VALIDATE_CONFIG{验证配置}
VALIDATE_CONFIG --> |错误| USE_DEFAULT[使用默认配置]
VALIDATE_CONFIG --> |正确| APPLY_CONFIG[应用配置]
USE_DEFAULT --> APPLY_CONFIG
APPLY_CONFIG --> READY[系统就绪]
```

**图表来源**
- [api/main.py](file://api/main.py#L47-L52)
- [api/config.py](file://api/config.py#L96-L118)

### 常见问题及解决方案

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| API密钥无效 | 密钥格式错误或权限不足 | 检查密钥有效性，确认API访问权限 |
| 配置文件加载失败 | 文件路径错误或格式错误 | 验证文件路径和JSON格式 |
| 端口冲突 | 端口已被占用 | 更改PORT环境变量 |
| 内存不足 | 资源限制过低 | 增加mem_limit配置 |
| 权限错误 | 文件权限问题 | 检查配置文件和数据目录权限 |

### 配置验证命令

```bash
# 检查环境变量
env | grep DEEPWIKI

# 验证配置文件语法
python -c "import json; print(json.loads(open('api/config/generator.json').read()))"

# 测试配置加载
python -c "from api.config import configs; print(configs.keys())"
```

**章节来源**
- [api/main.py](file://api/main.py#L47-L52)
- [api/config.py](file://api/config.py#L96-L118)

## 最佳实践

### 配置管理最佳实践

1. **版本控制配置文件**：将配置文件纳入版本控制系统
2. **使用环境变量**：敏感信息通过环境变量传递
3. **分环境配置**：为开发、测试、生产环境维护不同的配置
4. **定期备份配置**：重要配置变更前进行备份
5. **文档化配置**：为复杂配置添加注释说明

### 性能优化建议

1. **合理设置批处理大小**：根据内存容量调整embedder.json中的batch_size
2. **优化文本分割参数**：平衡chunk_size和chunk_overlap以提高检索质量
3. **选择合适的模型**：根据性能需求选择适当的AI模型
4. **监控资源使用**：定期检查CPU、内存和网络使用情况

### 安全考虑

1. **保护API密钥**：使用环境变量存储敏感信息
2. **限制访问权限**：配置适当的防火墙规则
3. **定期更新密钥**：建立密钥轮换机制
4. **审计配置变更**：记录所有配置修改历史

### 维护和监控

1. **设置健康检查**：利用Docker健康检查功能
2. **配置日志监控**：监控应用日志和错误信息
3. **定期性能评估**：评估系统响应时间和资源使用
4. **备份重要配置**：定期备份关键配置文件

通过遵循这些最佳实践，可以确保DeepWiki系统的稳定运行和高效维护，同时为用户提供优质的知识库构建体验。